<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CS2 Wall - Instastyle</title>
  <style>
    @import url('https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap');
    :root {
      --bg-main: #111015;
      --bg-content: #18171c;
      --card-max-width: 1100px;
      --radius: 21px;
      --shadow-light: 0 4px 20px -10px rgba(30,30,56,0.36), 0 1.5px 11px -6px #232337bb;
      --shadow-pop: 0 6px 48px -18px #0004, 0 3px 11px 0px #23233719;
      --border-card: #23222c;
      --btn-bg: #22222b;
      --btn-border: #2f2c40;
      --btn-radius: 22px;
      --btn-hover-bg: #23222c;
      --accent: #e2e1e9;
      --accent-text: #b9baff;
      --focus: #36374b;
      --input-bg: #212126;
      --input-border: #262637;
      --input-focus: #222234;
      --danger: #e05d82;
      --gray: #b2b4bf;
      --danger-light: #e05d823a;
      --surf-dark: #191822;
      --surface: #23222c;
      --icon-dark: #abb2d2;
      --tab-active: #23222c;
      --tab-active-bar: #6d5bff;
    }

    *, *:focus { outline: none; }
    html, body {
      min-height: 100vh;
      margin: 0;
      padding: 0;
      font-family: 'Inter', Arial, sans-serif;
      background: var(--bg-main);
      color: #edecf4;
      font-size: 17px;
      overflow-x: hidden;
      height: 100vh;
      cursor: default;
    }
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: stretch;
      align-items: center;
    }

    .container {
      width: 100vw;
      max-width: 100vw;
      margin: 32px auto 0 auto;
      background: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 42px;
    }

    .header-bar {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 0 20px 0;
      margin-bottom: 13px;
      border-bottom: 1.5px solid #23222c;
      max-width: var(--card-max-width);
      margin-left: auto;
      margin-right: auto;
    }

    .header-title {
      letter-spacing: .07em;
      font-size: 1.45rem;
      font-weight: 800;
      color: #fafafd;
      text-shadow: 0 1.5px 12px #23228836, 0 1px 0 #131321;
      text-transform: uppercase;
      font-style: italic;
      font-family: 'Inter', Arial, sans-serif;
    }

    .header-tabs {
      display: flex;
      gap: 2px;
      background: var(--surf-dark);
      border-radius: 17px;
      padding: 3px 4px;
      box-shadow: 0 0.5px 6px #1b1a258f;
    }
    .tab-btn {
      background: transparent;
      color: #c2c3cd;
      border: none;
      border-radius: 17px;
      font-size: 1.08rem;
      font-weight: 650;
      padding: 7px 23px 7px 24px;
      cursor: pointer;
      margin: 0;
      letter-spacing: .07em;
      font-family: inherit;
      transition: 
        background .12s, color .17s, box-shadow .13s;
      box-shadow: none;
      opacity: .89;
      position: relative;
      user-select: none;
    }
    .tab-btn.selected, .tab-btn:focus {
      background: var(--tab-active);
      color: #fafafd;
      box-shadow: 0 2px 11px -10px #2e2d3b99, 0 1px 5px -5px #22223d77;
      opacity: 1;
      font-weight: 800;
    }
    .tab-btn.selected:after, .tab-btn:focus:after {
      content: '';
      position: absolute;
      left: 25%;
      right: 25%;
      bottom: 2px;
      height: 2px;
      border-radius: 2px;
      background: var(--tab-active-bar);
      display: block;
    }
    .tab-btn.hide { display: none !important; }
    .tab-btn:hover:not(.selected) {
      opacity: 0.98;
      color: #fff;
      background: #27263a;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .card, .auth-container {
      background: var(--bg-content);
      border-radius: var(--radius);
      box-shadow: var(--shadow-light);
      border: 1.5px solid var(--border-card);
      padding: 32px 44px 24px 44px;
      z-index: 20;
      min-height: 60px;
      margin-bottom: 0;
      margin-top: 0;
      width: 98vw;
      max-width: var(--card-max-width);
      box-sizing: border-box;
    }
    .auth-container {
      margin: 0 auto;
      max-width: 500px;
      box-shadow: 0 1px 22px -9px #36345e13;
      border: 1.5px solid #252544;
    }

    h2, h3 {
      text-align: center;
      font-weight: 650;
      margin-top: 0;
      letter-spacing: 0.04em;
      color: #e4e5ec;
      font-family: 'Inter', Arial, sans-serif;
    }
    h2 { font-size: 1.45rem;}
    h3 { font-size: 1.11rem; margin-bottom: 1.3rem;}

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }
    label {
      font-size: 0.99em;
      font-weight: 500;
      color: #a1a1b5;
      margin-bottom: 3px;
      letter-spacing: 0.01em;
    }
    input[type="text"], input[type="password"], input[type="file"], textarea, select {
      background: var(--input-bg);
      border: 1.3px solid var(--input-border);
      color: #ececf2;
      font-size: 1.13em;
      border-radius: var(--radius);
      padding: 14px 15px;
      transition: border 0.14s, background 0.13s;
      font-family: inherit;
      outline: none;
      width: 100%;
      box-sizing: border-box;
    }
    input:focus, textarea:focus, select:focus {
      border-color: var(--focus);
      background: var(--input-focus);
    }
    textarea {
      resize: vertical;
      min-height: 78px;
      max-height: 250px;
      font-size: 1.13em;
      width: 100%;
      box-sizing: border-box;
    }
    button, .edit-profile-btn, .profile-pm-btn, .logout-btn {
      font-family: inherit;
      background: #23223b;
      color: #e7e8fb;
      font-size: 1.06rem;
      font-weight: 570;
      border-radius: var(--btn-radius);
      border: none;
      box-shadow: none;
      padding: 16px 0;
      letter-spacing: 0.11em;
      margin-top: 11px;
      cursor: pointer;
      transition: 
        background 0.13s, 
        color 0.13s, 
        letter-spacing 0.08s, 
        box-shadow 0.15s;
      min-width: 130px;
      margin-bottom: 2px;
      width: 180px;
      max-width: 100%;
      align-self: flex-end;
    }
    button:hover, .edit-profile-btn:hover, .profile-pm-btn:hover, .logout-btn:hover {
      background: #2c2c43;
      color: #fff;
      letter-spacing: 0.14em;
      box-shadow: 0 3px 26px -14px #7781fc42;
    }
    .message {
      display: flex;
      align-items: flex-start;
      gap: 17px;
      padding: 17px 24px 17px 18px;
      border-radius: 22px;
      background: #23222c;
      box-shadow: 0 1px 4px #0a0a1148;
      margin-bottom: 18px;
      min-height: 54px;
      flex-wrap: wrap;
      position: relative;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    .avatar {
      border-radius: 50%;
      width: 54px;
      height: 54px;
      object-fit: cover;
      background: #25253a;
      margin-right: 7px;
      border: 2px solid #282842;
      flex-shrink: 0;
      box-shadow: 0 2.5px 7px #29294623;
    }
    .msg-user {
      font-weight: 700;
      color: var(--accent-text);
      font-size: 1.15rem;
      display: flex;
      align-items: center;
      gap: 4.5px;
      cursor: pointer;
      text-decoration: none;
      margin-right: 7px;
      line-height: 1.18;
      user-select: text;
      transition: color 0.13s;
      min-width: 86px;
    }
    .msg-user[data-guest="1"],
    .msg-user[data-profile="-"] {
      color: #7e7e91;
      cursor: default;
      text-decoration: none;
    }
    .msg-user:hover:not([data-guest="1"]) {
      color: #fafafd;
      text-decoration: underline;
    }
    .msg-text {
      font-size: 1.23rem;
      color: #f2f2fb;
      flex: 13;
      font-weight: 455;
      letter-spacing: 0.01em;
      word-break: break-word;
      margin-left: 9px;
      line-height: 1.6;
      min-width: 100px;
    }
    .msg-time {
      color: #8c8ca2;
      font-size: 1.08em;
      margin-left: 7px;
      font-weight: 490;
      letter-spacing: .01em;
      align-self: flex-end;
      min-width: 58px;
      text-align: right;
    }
    .profile-view, .profile-other-view {
      text-align: center;
      padding: 4px 0 10px 0;
    }
    .avatar-large {
      width: 89px;
      height: 89px;
      margin: 0 auto 1.2rem auto;
      display: block;
      border-radius: 50%;
      background: #181821;
      border: 3px solid #27275311;
      margin-bottom: 11px;
    }
    .edit-profile-btn,
    .profile-pm-btn {
      font-size: 1.06rem;
      background: #212132;
      color: #babaff;
      border: 1.1px solid #363672;
      min-width: 132px;
      margin-top: 13px;
      margin-right: 8px;
      padding: 10px 20px;
      border-radius: var(--btn-radius);
      display: inline-block;
      transition: background 0.12s, color 0.11s;
      cursor: pointer;
      font-weight: 670;
      letter-spacing: 0.045em;
      box-sizing: border-box;
    }
    .profile-pm-btn {
      background: #211c28;
      color: #dbdafd;
      border-color: #363672;
      margin-top: 1.05rem;
      margin-bottom: .7rem;
    }
    .error-msg {
      color: var(--danger);
      background: transparent;
      font-size: 1rem;
      margin-bottom: 7px;
      margin-top: 0.5em;
      text-align: center;
      font-weight: 500;
    }
    .success-msg {
      color: #6a66ff;
      background: transparent;
      font-size: 1rem;
      margin-bottom: 13px;
      text-align: center;
      font-weight: 500;
    }
    .logout-btn {
      background: #1a1a22;
      color: #c17693;
      border: 1.1px solid #292840;
      margin-top: 0.9rem;
      font-size: 1rem;
      min-width: 116px;
      font-weight: 600;
      padding: 9px 17px;
      border-radius: var(--btn-radius);
      transition: color 0.11s, border-color 0.12s, background 0.13s;
      margin-left: 5px;
    }
    .logout-btn:hover {
      background: var(--danger);
      color: #fafafd;
      border-color: var(--danger);
    }
    .messages-area {
      width: 100%;
      max-width: var(--card-max-width);
      margin: 20px auto 0 auto;
      min-height: 360px;
      box-sizing: border-box;
    }
    ::selection { background: #252547; color: #ededed;}
    @media (max-width:1500px) {
      .container {max-width: 99vw;padding: 0 2vw 18px 2vw;}
      .card {max-width:99vw;}
      .messages-area {max-width: 99vw;}
      .header-bar {max-width: 99vw;}
    }
    @media (max-width:850px) {
      :root { --card-max-width: 99vw; }
      .card, .messages-area, .header-bar { max-width: 99vw; padding-left: 2vw; padding-right: 2vw; }
      .msg-text { font-size: 1.04rem; }
      .avatar { width: 41px; height: 41px;}
    }
    @media (max-width:600px) {
      .card, .messages-area, .header-bar { padding-left: 3.5vw; padding-right: 3.5vw; }
      .msg-user, .msg-text { font-size: 1em; }
    }
    body.clean-mode .messages-area,
    body.clean-mode .msg-list-title { display: none !important; }
    body.clean-mode #guest-info { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-bar">
      <div class="header-title">Instawall</div>
      <div class="header-tabs" id="header-tabs">
        <button class="tab-btn selected" id="tab-main">Feed</button>
        <button class="tab-btn" id="tab-pm">Üzenetek</button>
        <button class="tab-btn" id="tab-profile">Profil</button>
        <button class="tab-btn" id="tab-logout">Kijelentkezés</button>
        <button class="tab-btn" id="tab-login">Belépés</button>
        <button class="tab-btn" id="tab-register">Regisztráció</button>
      </div>
    </div>

    <div id="guest-info" class="card" style="margin-top:0.7rem; display:none;">
      <b>Vendég módban posztolhatsz a falra.</b> Profil funkciók csak bejelentkezéssel elérhetőek.
      <br>
      <span style="color:#85849b; font-size:.99em;">Privát üzenetek csak regisztráltaknak.</span>
    </div>
    
    <!-- TABS START-->
    <!-- MAIN FEED -->
    <div class="tab-content active" id="main-tab-content">
      <div class="msg-list-title" style="margin-top:0; margin-bottom:7px;">
        <h3 style="font-size:1.18rem; color:#bdbbf6; margin-bottom:.22em;">📝 Feed</h3>
      </div>
      <div class="card" id="main-card">
        <!-- Main post entry (profile part displayed here if logged in only) -->
        <div class="profile-view" id="main-profile-view" style="display:none;">
          <img src="" id="user-avatar" class="avatar avatar-large" alt="Avatar" style="display:none">
          <div style="font-size:1.11rem;margin-bottom:7px;" id="user-name-view"></div>
        </div>
        <form id="msg-form" style="margin-top:18px; width:100%; box-sizing:border-box;" autocomplete="off">
          <textarea id="message" placeholder="Mit posztolsz?" rows="4" maxlength="300" style="width:100%"></textarea>
          <button type="submit" style="margin-top:0; float:right;">Küldés</button>
        </form>
        <div class="error-msg hide" id="msg-error"></div>
        <div class="success-msg hide" id="msg-success"></div>
        <!-- Guest form -->
        <div id="guest-main-form" style="margin-top:18px;">
          <div class="profile-view">
            <img src="https://i.pravatar.cc/110?u=guest" class="avatar avatar-large" alt="Guest Avatar" style="display:block">
            <div style="font-size:1.11rem;margin-bottom:8px;">Vendég</div>
          </div>
          <form id="guest-msg-form" autocomplete="off" style="width:100%; box-sizing:border-box;">
            <textarea id="guest-message" placeholder="Vendég poszt..." rows="4" maxlength="300" style="width:100%"></textarea>
            <button type="submit" style="margin-top:0; float:right;">Küldés</button>
          </form>
          <div class="error-msg hide" id="guest-msg-error"></div>
          <div class="success-msg hide" id="guest-msg-success"></div>
        </div>
      </div>
      <div id="messages" class="messages-area"></div>
    </div>
    
    <!-- PROFILE TAB -->
    <div class="tab-content" id="profile-tab-content">
      <div class="card auth-container" id="profile-tab-card">
        <div class="profile-view" id="profile-view-main">
          <img src="" id="profile-tab-avatar" class="avatar avatar-large" alt="Avatar" style="display:none">
          <div style="font-size:1.09rem;margin-bottom:7px;" id="profile-tab-name"></div>
          <button class="edit-profile-btn" id="edit-profile-btn">Profil szerk.</button>
        </div>
        <div id="edit-profile-section" style="display:none;">
          <h3>Profil szerkesztés</h3>
          <form id="edit-profile-form" enctype="multipart/form-data">
            <div class="input-group">
              <label for="edit-avatar-file">Avatar feltöltése</label>
              <input type="file" id="edit-avatar-file" accept="image/*">
            </div>
            <button type="submit">Mentés</button>
          </form>
          <button class="logout-btn" id="cancel-edit-btn" style="margin-top:0.7rem;">Mégse</button>
          <div class="success-msg hide" id="profile-success"></div>
          <div class="error-msg hide" id="profile-error"></div>
        </div>
      </div>
    </div>

    <!-- PM TAB -->
    <div class="tab-content" id="pm-tab-content">
      <div class="card" id="pm-card">
        <div style="text-align:center;font-weight:bold;color:#bdbbf6;font-size:1.16em;margin-bottom:.7em;">Privát Üzenetek</div>
        <div id="pm-userlist"></div>
        <div id="pm-thread-area"></div>
        <div class="success-msg hide" id="pm-success"></div>
        <div class="error-msg hide" id="pm-error"></div>
      </div>
    </div>

    <!-- REGISTRATION TAB -->
    <div class="tab-content" id="register-tab-content">
      <div class="card auth-container" id="register-card">
        <h3>Regisztráció</h3>
        <form id="register-form" autocomplete="off" enctype="multipart/form-data">
          <div class="input-group">
            <label for="reg-username">Felhasználónév</label>
            <input type="text" id="reg-username" required maxlength="18" placeholder="Felhasználónév" autocomplete="off">
          </div>
          <div class="input-group">
            <label for="reg-password">Jelszó</label>
            <input type="password" id="reg-password" required maxlength="48" placeholder="Jelszó" autocomplete="new-password">
          </div>
          <div class="input-group">
            <label for="reg-avatar-file">Avatar kép</label>
            <input type="file" id="reg-avatar-file" accept="image/*">
          </div>
          <button type="submit">Regisztráció</button>
          <div class="error-msg hide" id="reg-error"></div>
          <div class="success-msg hide" id="reg-success"></div>
        </form>
      </div>
    </div>

    <!-- LOGIN TAB -->
    <div class="tab-content" id="login-tab-content">
      <div class="card auth-container" id="login-card">
        <h3>Belépés</h3>
        <form id="login-form" autocomplete="off">
          <div class="input-group">
            <label for="login-username">Felhasználónév</label>
            <input type="text" id="login-username" required maxlength="18" placeholder="Felhasználónév" autocomplete="username">
          </div>
          <div class="input-group">
            <label for="login-password">Jelszó</label>
            <input type="password" id="login-password" required maxlength="48" placeholder="Jelszó" autocomplete="current-password">
          </div>
          <button type="submit">Belépés</button>
          <div class="error-msg hide" id="login-error"></div>
        </form>
      </div>
    </div>
    <!-- TABS END-->
  </div>

<script type="module">
// -- original javascript, UNCHANGED --
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, set, get, child, update }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // --- Firebase config (unchanged, see original) ---
  const firebaseConfig = {
    apiKey: "AIzaSyC3Cgmy41qLWLy-HLVAyn1QFejdlflUnSY",
    authDomain: "website-26acc.firebaseapp.com",
    databaseURL: "https://website-26acc-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "website-26acc",
    storageBucket: "website-26acc-firebasestorage.app",
    messagingSenderId: "156168009563",
    appId: "1:156168009563:web:e464ba2d56f32138190c7e",
    measurementId: "G-P4XTEHXV4C"
  };

  // --- Simple hash ---
  function hash(str) {
    let hash = 0, i, chr;
    if (str.length === 0) return hash;
    for (i = 0; i < str.length; i++) {
      chr = str.charCodeAt(i);
      hash = ((hash<<5)-hash)+chr;
      hash |= 0;
    }
    return Math.abs(hash).toString(36);
  }

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const usersRef = ref(db, "users");
  const messagesRef = ref(db, "messages");
  const pmRef = ref(db, "pm");

  let currentUser = null;
  let currentAvatar = '';
  let guestMode = true;
  let currentTab = "main";

  // Tab selectors
  const tabs = {
    main: document.getElementById("main-tab-content"),
    pm: document.getElementById("pm-tab-content"),
    profile: document.getElementById("profile-tab-content"),
    register: document.getElementById("register-tab-content"),
    login: document.getElementById("login-tab-content")
  };
  const tabBtns = {
    main: document.getElementById("tab-main"),
    pm: document.getElementById("tab-pm"),
    profile: document.getElementById("tab-profile"),
    register: document.getElementById("tab-register"),
    login: document.getElementById("tab-login"),
    logout: document.getElementById("tab-logout")
  };

  // Show only active tab content
  function showTab(tabKey) {
    for (let k in tabs) tabs[k].classList.remove("active");
    tabs[tabKey].classList.add("active");
    for (let k in tabBtns) tabBtns[k].classList.remove("selected");
    if (tabBtns[tabKey]) tabBtns[tabKey].classList.add("selected");
    currentTab = tabKey;
    // Special: toggle profile view/edit sub-views
    if (tabKey === "profile") {
      showProfileMainView();
    }
    if(tabKey === "pm") {
      loadPmUserList();
    }
    // Hide guest info except on main tab (and only if guest)
    updateHeaderBtns();
    updateMainMsgFormDisplay();
  }

  // Tabs event listeners
  tabBtns.main.onclick = () => showTab("main");
  tabBtns.profile.onclick = () => showTab("profile");
  tabBtns.pm.onclick = () => showTab("pm");
  tabBtns.register.onclick = () => showTab("register");
  tabBtns.login.onclick = () => showTab("login");
  tabBtns.logout.onclick = () => {logout();};

  // Username etc selectors
  const userAvatarView = document.getElementById("user-avatar");
  const userNameView = document.getElementById("user-name-view");
  const profileTabAvatar = document.getElementById("profile-tab-avatar");
  const profileTabName = document.getElementById("profile-tab-name");
  const editProfileBtn = document.getElementById("edit-profile-btn");
  const editProfileSection = document.getElementById("edit-profile-section");
  const profileViewMain = document.getElementById("profile-view-main");
  const guestInfo = document.getElementById('guest-info');
  const mainProfileView = document.getElementById('main-profile-view');
  const guestMainForm = document.getElementById('guest-main-form');
  const messagesArea = document.getElementById("messages");
  const pmUserlist = document.getElementById("pm-userlist");
  const pmThreadArea = document.getElementById("pm-thread-area");

  // Top bar Logout (tab-logout) is always visible only if logged in
  function updateHeaderBtns() {
    if (guestMode) {
      tabBtns.main.style.display = "";
      tabBtns.register.style.display = "";
      tabBtns.login.style.display = "";
      tabBtns.profile.style.display = "none";
      tabBtns.pm.style.display = "none";
      tabBtns.logout.style.display = "none";
      guestInfo.style.display = (currentTab==="main") ? "" : "none";
    } else {
      tabBtns.main.style.display = "";
      tabBtns.profile.style.display = "";
      tabBtns.pm.style.display = "";
      tabBtns.logout.style.display = "";
      tabBtns.register.style.display = "none";
      tabBtns.login.style.display = "none";
      guestInfo.style.display = "none";
    }
  }

  function updateMainMsgFormDisplay() {
    // Main tab: show/hide between guest and user form/fields
    const mainCard = document.getElementById("main-card");
    const msgForm = document.getElementById("msg-form");
    if (guestMode) {
      msgForm.style.display = "none";
      mainProfileView.style.display = "none";
      guestMainForm.style.display = "";
    } else {
      msgForm.style.display = "";
      mainProfileView.style.display = "";
      guestMainForm.style.display = "none";
      updateProfileBar();
    }
  }

  // Update profile bar in main tab
  function updateProfileBar() {
    if (!guestMode) {
      userNameView.textContent = currentUser;
      if (currentAvatar && currentAvatar.length > 10) {
        userAvatarView.src = currentAvatar;
      } else {
        userAvatarView.src = "https://i.pravatar.cc/110?u=" + encodeURIComponent(currentUser);
      }
      userAvatarView.style.display = 'block';
    }
  }

  // Profile Tab main view
  function showProfileMainView() {
    if (!guestMode) {
      editProfileSection.style.display = "none";
      profileViewMain.style.display = "";
      // profile info
      profileTabName.textContent = currentUser;
      if (currentAvatar && currentAvatar.length > 10) {
        profileTabAvatar.src = currentAvatar;
      } else {
        profileTabAvatar.src = "https://i.pravatar.cc/110?u=" + encodeURIComponent(currentUser);
      }
      profileTabAvatar.style.display = 'block';
    } else {
      tabs.profile.innerHTML = `<div class="card auth-container"><div style="text-align:center; color:#85849b;">Bejelentkezés szükséges a profilhoz.</div></div>`;
    }
  }

  // Edit profile
  editProfileBtn.onclick = function() {
    editProfileSection.style.display = "";
    profileViewMain.style.display = "none";
    document.getElementById('profile-error').classList.add('hide');
    document.getElementById('profile-success').classList.add('hide');
  };

  document.getElementById('cancel-edit-btn').onclick = function() {
    showProfileMainView();
  };

  document.getElementById('edit-profile-form').onsubmit = async function(e) {
    e.preventDefault();
    const avatarFile = document.getElementById('edit-avatar-file').files[0];
    let newAvatar = "";
    if (avatarFile) {
      if (!avatarFile.type.startsWith('image/')) {
        document.getElementById('profile-error').textContent = "Csak képet tölts fel!";
        document.getElementById('profile-error').classList.remove('hide');
        return;
      }
      newAvatar = await fileToBase64Square(avatarFile, 74);
    }
    try {
      if (newAvatar) {
        await update(child(usersRef, currentUser), { avatar: newAvatar });
        currentAvatar = newAvatar;
      }
      document.getElementById('profile-success').textContent = "Elmentve!";
      document.getElementById('profile-success').classList.remove('hide');
      setTimeout(() => {
        showProfileMainView();
      }, 1000);
    } catch (e) {
      document.getElementById('profile-error').textContent = "Mentés sikertelen.";
      document.getElementById('profile-error').classList.remove('hide');
    }
  };

  // Main message sending logic
  document.getElementById('msg-form').onsubmit = async function(e) {
    e.preventDefault();
    const msg = document.getElementById('message').value.trim();
    document.getElementById('msg-error').classList.add('hide');
    document.getElementById('msg-success').classList.add('hide');
    if (!msg) {
      document.getElementById('msg-error').textContent = "Írj valamit!";
      document.getElementById('msg-error').classList.remove('hide');
      return;
    }
    if (!currentUser) {
      document.getElementById('msg-error').textContent = "Előbb jelentkezz be!";
      document.getElementById('msg-error').classList.remove('hide');
      return;
    }
    try {
      await push(messagesRef, {
        name: currentUser,
        msg,
        avatar: currentAvatar || "",
        ts: Date.now()
      });
      document.getElementById('message').value = "";
      document.getElementById('msg-success').textContent = "Küldve!";
      document.getElementById('msg-success').classList.remove('hide');
      setTimeout(()=>{ document.getElementById('msg-success').classList.add('hide'); }, 900);
    } catch(e) {
      document.getElementById('msg-error').textContent = "Hiba küldéskor!";
      document.getElementById('msg-error').classList.remove('hide');
    }
  };

  // Guest send message
  document.getElementById('guest-msg-form').onsubmit = async function(e) {
    e.preventDefault();
    const msg = document.getElementById('guest-message').value.trim();
    document.getElementById('guest-msg-error').classList.add('hide');
    document.getElementById('guest-msg-success').classList.add('hide');
    if(!msg) {
      document.getElementById('guest-msg-error').textContent = "Írj valamit!";
      document.getElementById('guest-msg-error').classList.remove('hide');
      return;
    }
    try {
      await push(messagesRef, {
        name: "Vendég",
        guest: true,
        msg,
        avatar: "",
        ts: Date.now()
      });
      document.getElementById('guest-message').value = "";
      document.getElementById('guest-msg-success').textContent = "Küldve!";
      document.getElementById('guest-msg-success').classList.remove('hide');
      setTimeout(()=>{ document.getElementById('guest-msg-success').classList.add('hide'); }, 900);
    } catch(e) {
      document.getElementById('guest-msg-error').textContent = "Hiba küldéskor!";
      document.getElementById('guest-msg-error').classList.remove('hide');
    }
  };

  // Registration logic
  document.getElementById('register-form').onsubmit = async function(e) {
    e.preventDefault();
    const uname = document.getElementById('reg-username').value.trim();
    const pwd = document.getElementById('reg-password').value.trim();
    const avatarFile = document.getElementById('reg-avatar-file').files[0];
    const regError = document.getElementById('reg-error');
    const regSuccess = document.getElementById('reg-success');
    regError.textContent = '';
    regError.classList.add('hide');
    regSuccess.textContent = '';
    regSuccess.classList.add('hide');

    if(uname.length < 3) {
      regError.textContent = "Felhasználónév 3+ karakter!";
      regError.classList.remove('hide');
      return;
    }
    if(pwd.length < 5) {
      regError.textContent = "Jelszó 5+ karakter!";
      regError.classList.remove('hide');
      return;
    }
    const usersSnap = await get(usersRef);
    let userExists = false;
    usersSnap.forEach(childSnap => {
      if(childSnap.key.toLowerCase() === uname.toLowerCase()) userExists = true;
    });
    if(userExists) {
      regError.textContent = "Felhasználónév foglalt!";
      regError.classList.remove('hide');
      return;
    }
    let avatarData = "";
    if (avatarFile) {
      if (!avatarFile.type.startsWith('image/')) {
        regError.textContent = "Csak képet tölts fel!";
        regError.classList.remove('hide');
        return;
      }
      avatarData = await fileToBase64Square(avatarFile, 74);
    }
    await set(child(usersRef, uname), {
      username: uname,
      password: hash(pwd),
      avatar: avatarData || ""
    });
    regSuccess.textContent = "Sikeres regisztráció! Most beléphetsz.";
    regSuccess.classList.remove('hide');
    setTimeout(() => {
      regSuccess.classList.add('hide');
      showTab("login");
    }, 1100);
    document.getElementById('register-form').reset();
  };

  // Login logic
  document.getElementById('login-form').onsubmit = async function(e) {
    e.preventDefault();
    const uname = document.getElementById('login-username').value.trim();
    const pwd = document.getElementById('login-password').value.trim();
    const loginError = document.getElementById('login-error');
    loginError.textContent = '';
    loginError.classList.add('hide');
    const usersSnap = await get(usersRef);
    let found = false;
    usersSnap.forEach(childSnap => {
      if(childSnap.key.toLowerCase() === uname.toLowerCase()) {
        found = childSnap.val();
      }
    });
    if(!found) {
      loginError.textContent = "Hibás adat!";
      loginError.classList.remove('hide');
      return;
    }
    if(found.password !== hash(pwd)) {
      loginError.textContent = "Hibás adat!";
      loginError.classList.remove('hide');
      return;
    }
    currentUser = found.username;
    currentAvatar = found.avatar;
    guestMode = false;
    showTab("main");
  };

  function logout() {
    currentUser = null;
    currentAvatar = '';
    guestMode = true;
    showTab("main");
  }

  // Format time for messages
  function formatTimeAgo(ts) {
    if(!ts) return "";
    const ms = Date.now() - ts;
    const sec = Math.floor(ms/1000);
    if(sec < 60) return 'most';
    if(sec < 3600) return (sec/60|0)+'p';
    if(sec < 86400) return (sec/3600|0)+'ó';
    return (sec/86400|0)+' napja';
  }

  // Main message listing
  onValue(messagesRef, (snapshot) => {
    messagesArea.innerHTML = "";
    let msgArr = [];
    snapshot.forEach((child) => {
      msgArr.push({ id: child.key, ...child.val() });
    });
    // Sort: latest first
    msgArr.sort((a,b)=> b.ts-a.ts);
    msgArr.forEach(data => {
      const div = document.createElement("div");
      div.className = "message";
      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      if (data.avatar && data.avatar.length > 10) {
        avatar.src = data.avatar;
      } else {
        avatar.src = data.guest ? "https://i.pravatar.cc/52?u=guest" : ("https://i.pravatar.cc/52?u=" + encodeURIComponent(data.name));
      }
      avatar.alt = "-";
      const name = document.createElement('span');
      name.className = 'msg-user';
      if (data.guest || !data.name) {
        name.textContent = data.name || "Vendég";
        name.dataset.guest = "1";
      } else {
        name.textContent = data.name;
        name.dataset.profile = data.name;
      }
      const time = document.createElement('span');
      time.className = 'msg-time';
      time.textContent = '• ' + formatTimeAgo(data.ts);
      const msgElem = document.createElement('span');
      msgElem.className = 'msg-text';
      msgElem.textContent = data.msg;
      div.appendChild(avatar);
      div.appendChild(name);
      div.appendChild(time);
      div.appendChild(msgElem);
      messagesArea.appendChild(div);
    });
  });

  // ---- PM SECTION ----
  async function loadPmUserList() {
    pmUserlist.innerHTML = "<div style='margin-bottom:.6em; color:#868686'>Kattints egy felhasználóra!</div>";
    pmThreadArea.innerHTML = "";
    if (!currentUser) {
      pmUserlist.innerHTML += '<div style="color:#e05d82;text-align:center;">Lépj be!</div>';
      return;
    }
    const usersSnap = await get(usersRef);
    let userArr = [];
    usersSnap.forEach(childSnap => {
      const user = childSnap.val();
      if (user.username && user.username !== currentUser) {
        userArr.push(user.username);
      }
    });
    if (userArr.length == 0) {
      pmUserlist.innerHTML += "<div style='color:#777;text-align:center;'>Más regisztrált nincs.</div>";
      return;
    }
    userArr.forEach(uname => {
      const btn = document.createElement("button");
      btn.className = "edit-profile-btn";
      btn.style.marginRight = "0";
      btn.textContent = uname;
      btn.onclick = () => openPmThread(uname);
      pmUserlist.appendChild(btn);
    });
  }

  async function openPmThread(targetName) {
    pmThreadArea.innerHTML = `
      <div style="text-align:center; font-size:1.04em; color:#9091c6;margin-bottom:0.5rem;">
        Üzenet: <b>${currentUser}</b> — <b>${targetName}</b>
      </div>
      <div id="pmthread-messages" style="max-height:420px;overflow-y:auto;margin-bottom:13px;width:100%;"></div>
      <form id="pmthread-form" style="background:none;width:100%;">
        <input type="text" id="pmthread-input" placeholder="Írj valamit..." maxlength="300" style="width:84%;display:inline-block;" />
        <button type="submit" style="width:15%;display:inline-block;margin-left:1%;">Küldés</button>
      </form>
      <button class="logout-btn" id="close-pmthread-btn" style="margin-top:0.6rem;">Vissza</button>
    `;
    const threadId = getPmThreadId(currentUser, targetName);
    const threadRef = child(pmRef, threadId);
    onValue(threadRef, snap => {
      const threadMsgs = [];
      snap.forEach(childSnap => threadMsgs.push(childSnap.val()));
      threadMsgs.sort((a,b)=>a.ts-b.ts);
      const msgbox = pmThreadArea.querySelector('#pmthread-messages');
      msgbox.innerHTML = '';
      threadMsgs.forEach(data => {
        const msgDiv = document.createElement("div");
        msgDiv.style = "margin-bottom:6px; display:flex; align-items:center; gap: 12px;";
        const who = document.createElement('span');
        who.style = "color:#aaa;min-width:63px;font-weight:600;font-size:1.05em;";
        who.textContent = data.from === currentUser ? "Te" : data.from;
        const text = document.createElement('span');
        text.textContent = data.msg;
        text.style = "background:#23223b; color:#fafafd;border-radius:8px; padding:8px 20px;display:inline-block; font-size:1.12em;";
        msgDiv.appendChild(who);
        msgDiv.appendChild(text);
        msgbox.appendChild(msgDiv);
      });
      msgbox.scrollTop = msgbox.scrollHeight;
    });
    pmThreadArea.querySelector('#pmthread-form').onsubmit = async function(e) {
      e.preventDefault();
      const msgInput = pmThreadArea.querySelector('#pmthread-input');
      const msg = msgInput.value.trim();
      if (!msg) return;
      try {
        await push(child(pmRef, threadId), {
          from: currentUser,
          msg,
          ts: Date.now()
        });
        msgInput.value = '';
      } catch (e) {
        document.getElementById('pm-error').textContent = "Nem sikerült elküldeni!";
        document.getElementById('pm-error').classList.remove('hide');
      }
    }
    pmThreadArea.querySelector('#close-pmthread-btn').onclick = () => loadPmUserList();
  }
  function getPmThreadId(user1, user2) {
    return [user1, user2].sort().join('__pm__');
  }

  // -- Image file to base64 helper, resize square
  function fileToBase64Square(file, sz) {
    return new Promise(function(resolve) {
      const reader = new FileReader();
      reader.onload = function(evt) {
        const img = new window.Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          canvas.width = sz;
          canvas.height = sz;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = "#181821";
          ctx.fillRect(0,0,sz,sz);
          let size = Math.min(img.width, img.height);
          let sx = (img.width-size)/2;
          let sy = (img.height-size)/2;
          ctx.drawImage(img, sx, sy, size, size, 0, 0, sz, sz);
          resolve(canvas.toDataURL('image/png'));
        };
        img.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    });
  }

  // ------- INIT -------
  function initTabDisplay() {
    updateHeaderBtns();
    updateMainMsgFormDisplay();
    showTab("main");
  }
  initTabDisplay();

</script>
</body>
</html>
