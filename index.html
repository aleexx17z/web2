<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CS2 √úzen≈ëfal</title>
  <style>
    @import url('https://fonts.googleapis.com/css?family=Inter:400,700&display=swap');
    html, body {
      background: #131313;
      color: #f1f1f1;
      font-family: 'Inter', Arial, sans-serif;
      height: 100%;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      cursor: url('https://cur.cursors-4u.net/symbols/sym-6/sym591.cur'), auto;
      transition: background 0.3s;
    }

    body {
      max-width: 425px;
      margin: 40px auto;
      box-shadow: 0 0 0.5rem #0008;
      border-radius: 14px;
      padding: 25px 18px 20px 18px;
      background: #191c20;
      min-height: 82vh;
    }

    h2,h3 { text-align: center; font-weight: 700; letter-spacing: 1px;}
    h2 { font-size: 1.7rem; margin-top: 0;}
    h3 { font-size: 1.1rem; margin-bottom: 0.5rem; margin-top:2.6rem; letter-spacing:0.5px;}

    .card, .auth-container {
      background: #212127cf;
      border-radius: 10px;
      padding: 22px 24px;
      box-shadow: 0 0 1.5rem #000a;
      margin-bottom: 22px;
      margin-top: 1.5rem;
      transition: box-shadow 0.2s;
    }
    .card {
      margin-top:0;
      margin-bottom:1.5rem;
    }
    .auth-container {
      margin-bottom:1.2rem;
    }

    input, textarea, button, select {
      width: 100%;
      margin-bottom: 14px;
      margin-top: 5px;
      padding: 12px;
      font-size: 1.13rem;
      border-radius: 8px;
      border: 1.5px solid #292933;
      background: #191b20;
      color: #f3f3f7;
      box-sizing: border-box;
      outline: none;
      font-family: inherit;
      transition: border 0.2s, background 0.2s;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #36e491;
      background-color: #212127;
    }
    button {
      background-color: #20ac69;
      color: #fff;
      cursor: pointer;
      border: none;
      font-weight: 600;
      font-size: 1rem;
      padding: 13px;
      border-radius: 8px;
      box-shadow: 0 4px 14px -5px #20ac6953;
      transition: background 0.18s, transform 0.17s;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-top: 10px;
    }
    button:hover {
      background: linear-gradient(92deg, #20ac69 60%, #107758 100%);
      transform: translateY(-2px) scale(1.03);
    }
    .message {
      padding: 10px 16px 9px 16px;
      margin-bottom: 12px;
      border-radius: 9px;
      background: #202228;
      color: #fafafa;
      box-shadow: 0 2px 8px -6px #333;
      position: relative;
      transition: background 0.17s;
      display: flex;
      align-items: center;
      gap: 13px;
      min-height: 47px;
    }
    .msg-user {
      font-weight: 600;
      color: #36e491;
      margin-right: 6px;
      font-size: 1.09rem;
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .msg-text {
      font-size: 1.01rem;
      letter-spacing: 0px;
      flex: 1;
    }
    .avatar {
      border-radius: 50%;
      width: 34px;
      height: 34px;
      object-fit: cover;
      background: #292929;
      margin-right: 10px;
      border: 1.5px solid #36e49144;
      flex-shrink: 0;
    }
    .edit-profile-btn {
      font-size:0.97rem;
      margin-top:0.8rem;
      background: #29293b;
      color:#90ffcb;
      border:1px solid #36e49133;
    }
    .edit-profile-btn:hover {
      background: #23232b;
      color:#36e491;
    }
    .profile-view {
      text-align: center;
      padding: 4px 0 10px 0;
    }
    .avatar-large {
      width: 74px;
      height: 74px;
      margin: 0 auto 1.2rem auto;
      display: block;
    }

    .flex-center {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .hide {
      display: none !important;
    }
    .error-msg {
      color:#ff5454;
      font-size: 0.97rem;
      margin-bottom: 9px;
      text-align: center;
      margin-top:-5px;
    }
    .success-msg {
      color: #37ffa7;
      font-size: 1rem;
      margin-bottom: 13px;
      text-align: center;
    }
    .logout-btn {
      background: #151516;
      color: #f56;
      border: 1.5px solid #2f2f38;
      margin-top: 0.7rem;
      font-size: 0.99rem;
    }
    ::selection { background: #36e49132; color: #fff;}
    @media (max-width:600px) { body { max-width:100vw; padding:0 3vw;} }
  </style>
</head>
<body>
  <h2>CS2 √úzen≈ëfal</h2>
  <div class="card auth-container" id="register-card">
    <h3>Regisztr√°ci√≥</h3>
    <form id="register-form" autocomplete="off">
      <input type="text" id="reg-username" required maxlength="18" placeholder="Felhaszn√°l√≥n√©v" autocomplete="off">
      <input type="password" id="reg-password" required maxlength="48" placeholder="Jelsz√≥" autocomplete="new-password">
      <input type="text" id="reg-avatar" maxlength="210" placeholder="Avatar k√©p URL (opcion√°lis) üì∏" autocomplete="off">
      <button type="submit">Regisztr√°lok</button>
      <div class="error-msg hide" id="reg-error"></div>
      <div class="success-msg hide" id="reg-success"></div>
    </form>
    <div style="margin-top:11px; text-align:center;">M√°r van felhaszn√°l√≥d?<br>
      <a href="#" id="switch-to-login" style="color:#36e491;">Bejelentkez√©s</a>
    </div>
  </div>
  <div class="card auth-container hide" id="login-card">
    <h3>Bejelentkez√©s</h3>
    <form id="login-form" autocomplete="off">
      <input type="text" id="login-username" required maxlength="18" placeholder="Felhaszn√°l√≥n√©v" autocomplete="username">
      <input type="password" id="login-password" required maxlength="48" placeholder="Jelsz√≥" autocomplete="current-password">
      <button type="submit">Bel√©pek</button>
      <div class="error-msg hide" id="login-error"></div>
    </form>
    <div style="margin-top:11px; text-align:center;">Nincs fi√≥kod?<br>
      <a href="#" id="switch-to-register" style="color:#36e491;">Regisztr√°lj</a>
    </div>
  </div>
  <div class="card hide" id="main-card">
    <div class="profile-view">
      <img src="" id="user-avatar" class="avatar avatar-large" alt="Avatar" style="display:none">
      <div style="font-size:1.13rem;margin-bottom:9px;" id="user-name-view"></div>
      <button class="edit-profile-btn" id="edit-profile-btn">Profil szerkeszt√©se</button>
      <button class="logout-btn" id="logout-btn">Kijelentkez√©s</button>
    </div>
    <form id="msg-form" style="margin-top:24px;">
      <textarea id="message" placeholder="√úzeneted..." rows="3" maxlength="300"></textarea>
      <button type="submit" style="margin-top:0;">√úzenet k√ºld√©se</button>
    </form>
    <div class="error-msg hide" id="msg-error"></div>
    <div class="success-msg hide" id="msg-success"></div>
  </div>
  <div class="card hide" id="edit-profile-card">
    <h3>Profil szerkeszt√©se</h3>
    <form id="edit-profile-form">
      <input type="text" id="edit-avatar" maxlength="210" placeholder="√öj avatar URL">
      <button type="submit">Ment√©s</button>
    </form>
    <button class="logout-btn" id="cancel-edit-btn" style="margin-top:0.8rem;">M√©gse</button>
    <div class="success-msg hide" id="profile-success"></div>
    <div class="error-msg hide" id="profile-error"></div>
  </div>
  <h3 style="margin-top:13px;">üìú √úzenetek:</h3>
  <div id="messages"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, get, child, update } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC3Cgmy41qLWLy-HLVAyn1QFejdlflUnSY",
      authDomain: "website-26acc.firebaseapp.com",
      databaseURL: "https://website-26acc-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "website-26acc",
      storageBucket: "website-26acc-firebasestorage.app",
      messagingSenderId: "156168009563",
      appId: "1:156168009563:web:e464ba2d56f32138190c7e",
      measurementId: "G-P4XTEHXV4C"
    };

    function hash(str) {
      // a simple hash to avoid storing passwords in plain text (not cryptographically secure!)
      let hash = 0, i, chr;
      if (str.length === 0) return hash;
      for (i = 0; i < str.length; i++) {
        chr   = str.charCodeAt(i);
        hash  = ((hash<<5)-hash)+chr;
        hash |= 0;
      }
      return Math.abs(hash).toString(36);
    }

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const usersRef = ref(db, "users");
    const messagesRef = ref(db, "messages");

    let currentUser = null;
    let currentAvatar = '';

    //--- UI SELECTORS
    const registerCard = document.getElementById('register-card');
    const loginCard = document.getElementById('login-card');
    const mainCard = document.getElementById('main-card');
    const editProfileCard = document.getElementById('edit-profile-card');
    const msgTextarea = document.getElementById('message');
    const profileView = document.getElementById('user-name-view');
    const avatarView = document.getElementById('user-avatar');
    const editProfileBtn = document.getElementById('edit-profile-btn');
    const logoutBtn = document.getElementById('logout-btn');

    //-- CARDS switching
    document.getElementById('switch-to-login').onclick = e => {
      e.preventDefault();
      registerCard.classList.add('hide');
      loginCard.classList.remove('hide');
    };
    document.getElementById('switch-to-register').onclick = e => {
      e.preventDefault();
      loginCard.classList.add('hide');
      registerCard.classList.remove('hide');
    };

    //-- Registration
    document.getElementById('register-form').onsubmit = async function(e) {
      e.preventDefault();
      const uname = document.getElementById('reg-username').value.trim();
      const pwd = document.getElementById('reg-password').value.trim();
      let avatar = document.getElementById('reg-avatar').value.trim();
      const regError = document.getElementById('reg-error');
      const regSuccess = document.getElementById('reg-success');
      regError.textContent = '';
      regSuccess.textContent = '';

      if(uname.length < 3) {
        regError.textContent = "Felhaszn√°l√≥n√©v legal√°bb 3 karakter!";
        regError.classList.remove('hide');
        return;
      }
      if(pwd.length < 5) {
        regError.textContent = "Jelsz√≥ legal√°bb 5 karakter!";
        regError.classList.remove('hide');
        return;
      }
      if(avatar && (!/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp|svg|bmp|ico)(\?.*)?$/i.test(avatar))) {
        regError.textContent = "Avatar URL form√°tuma nem megfelel≈ë!";
        regError.classList.remove('hide');
        return;
      }
      regError.classList.add('hide');

      // Check if user exists
      const usersSnap = await get(usersRef);
      let userExists = false;
      usersSnap.forEach(childSnap => {
        if(childSnap.key.toLowerCase() === uname.toLowerCase()) userExists = true;
      });
      if(userExists) {
        regError.textContent = "Ez a felhaszn√°l√≥ m√°r l√©tezik!";
        regError.classList.remove('hide');
        return;
      }
      // Save user
      avatar = avatar || "https://i.pravatar.cc/110?u=" + encodeURIComponent(uname);
      await set(child(usersRef, uname), {
        username: uname,
        password: hash(pwd),
        avatar
      });
      regSuccess.textContent = "Sikeres regisztr√°ci√≥! Most bejelentkezhetsz.";
      regSuccess.classList.remove('hide');
      setTimeout(() => {
        regSuccess.classList.add('hide');
        registerCard.classList.add('hide');
        loginCard.classList.remove('hide');
      }, 1200);
      document.getElementById('register-form').reset();
    };

    //-- Login
    document.getElementById('login-form').onsubmit = async function(e) {
      e.preventDefault();
      const uname = document.getElementById('login-username').value.trim();
      const pwd = document.getElementById('login-password').value.trim();
      const loginError = document.getElementById('login-error');
      loginError.textContent = '';
      loginError.classList.add('hide');
      const usersSnap = await get(usersRef);
      let found = false, avatar = '';
      usersSnap.forEach(childSnap => {
        if(childSnap.key.toLowerCase() === uname.toLowerCase()) {
          found = childSnap.val();
        }
      });
      if(!found) {
        loginError.textContent = "Hib√°s felhaszn√°l√≥n√©v vagy jelsz√≥!";
        loginError.classList.remove('hide');
        return;
      }
      if(found.password !== hash(pwd)) {
        loginError.textContent = "Hib√°s felhaszn√°l√≥n√©v vagy jelsz√≥!";
        loginError.classList.remove('hide');
        return;
      }
      // Login ok!
      currentUser = found.username;
      currentAvatar = found.avatar;
      openMainView();
    };

    function openMainView() {
      loginCard.classList.add('hide');
      registerCard.classList.add('hide');
      mainCard.classList.remove('hide');
      editProfileCard.classList.add('hide');
      updateProfileBar();
    }
    function updateProfileBar() {
      profileView.textContent = currentUser;
      avatarView.src = currentAvatar;
      avatarView.style.display = 'block';
    }
    //-- Logout
    logoutBtn.onclick = function() {
      currentUser = null; currentAvatar = '';
      mainCard.classList.add('hide');
      loginCard.classList.remove('hide');
    };

    //-- Edit Profile
    editProfileBtn.onclick = function() {
      mainCard.classList.add('hide');
      editProfileCard.classList.remove('hide');
      document.getElementById('edit-avatar').value = currentAvatar;
      document.getElementById('profile-error').classList.add('hide');
      document.getElementById('profile-success').classList.add('hide');
    };
    document.getElementById('cancel-edit-btn').onclick = function() {
      editProfileCard.classList.add('hide');
      mainCard.classList.remove('hide');
    };
    document.getElementById('edit-profile-form').onsubmit = async function(e) {
      e.preventDefault();
      let newAvatar = document.getElementById('edit-avatar').value.trim();
      if(!newAvatar) {
        newAvatar = "https://i.pravatar.cc/110?u=" + encodeURIComponent(currentUser);
      }
      if(newAvatar && (!/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp|svg|bmp|ico)(\?.*)?$/i.test(newAvatar))) {
        document.getElementById('profile-error').textContent = "Hib√°s avatar URL!";
        document.getElementById('profile-error').classList.remove('hide');
        return;
      }
      try {
        await update(child(usersRef, currentUser), { avatar: newAvatar });
        currentAvatar = newAvatar;
        document.getElementById('profile-success').textContent = "Avatar mentve!";
        document.getElementById('profile-success').classList.remove('hide');
        setTimeout(() => {
          editProfileCard.classList.add('hide');
          mainCard.classList.remove('hide');
          updateProfileBar();
        }, 1000);
      } catch (e) {
        document.getElementById('profile-error').textContent = "Ment√©s sikertelen.";
        document.getElementById('profile-error').classList.remove('hide');
      }
    };

    // --- Send Message
    document.getElementById('msg-form').onsubmit = async function(e) {
      e.preventDefault();
      const msg = msgTextarea.value.trim();
      document.getElementById('msg-error').classList.add('hide');
      document.getElementById('msg-success').classList.add('hide');
      if(!msg) {
        document.getElementById('msg-error').textContent = "√úzenetet √≠rj!";
        document.getElementById('msg-error').classList.remove('hide');
        return;
      }
      if(!currentUser) {
        document.getElementById('msg-error').textContent = "El≈ëbb jelentkezz be!";
        document.getElementById('msg-error').classList.remove('hide');
        return;
      }
      try {
        await push(messagesRef, { 
          name: currentUser, 
          msg, 
          avatar: currentAvatar || "",
          ts: Date.now()
        });
        msgTextarea.value = "";
        document.getElementById('msg-success').textContent = "Elk√ºldve!";
        document.getElementById('msg-success').classList.remove('hide');
        setTimeout(()=>{ document.getElementById('msg-success').classList.add('hide'); }, 900);
      } catch(e) {
        document.getElementById('msg-error').textContent = "Hiba k√ºld√©skor!";
        document.getElementById('msg-error').classList.remove('hide');
      }
    };

    //-- Show/refresh messages
    function formatTimeAgo(ts) {
      if(!ts) return "";
      const ms = Date.now() - ts;
      const sec = Math.floor(ms/1000);
      if(sec < 60) return 'most';
      if(sec < 3600) return (sec/60|0)+'p';
      if(sec < 86400) return (sec/3600|0)+'√≥';
      return (sec/86400|0)+' napja';
    }
    onValue(messagesRef, (snapshot) => {
      const list = document.getElementById("messages");
      list.innerHTML = "";
      let msgArr = [];
      snapshot.forEach((child) => {
        msgArr.push({ id: child.key, ...child.val() });
      });
      // Sort: latest first
      msgArr.sort((a,b)=> b.ts-a.ts);
      msgArr.forEach(data => {
        const div = document.createElement("div");
        div.className = "message";
        const avatar = document.createElement('img');
        avatar.className = 'avatar';
        avatar.src = data.avatar || "https://i.pravatar.cc/52?u=" + encodeURIComponent(data.name);
        avatar.alt = "-";
        const name = document.createElement('span');
        name.className = 'msg-user';
        name.textContent = data.name;
        const time = document.createElement('span');
        time.style = 'color:#44f2a925; margin-left:7px; font-size:.92em;';
        time.textContent = '‚Ä¢ ' + formatTimeAgo(data.ts);
        const msgElem = document.createElement('span');
        msgElem.className = 'msg-text';
        msgElem.textContent = data.msg;
        div.appendChild(avatar);
        div.appendChild(name);
        div.appendChild(time);
        div.appendChild(msgElem);
        list.appendChild(div);
      });
    });
  </script>
</body>
</html>
